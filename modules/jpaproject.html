<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd";>
<!--
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements. See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License. You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<html>
  <head>
    <link rel="shortcut icon" href="http://aries.apache.org/images/favicon.ico"></link>
    <link type="text/css" rel="stylesheet" href="http://aries.apache.org/resources/site.css"></link>
    </script><script src="http://aries.apache.org/resources/menus.js" language="javascript" type="text/javascript"></script>
  <meta name="keywords" content="..."/>
  <meta name="description" content="..." />
    <title>
    Apache Aries - JPAProject
    </title>
  </head>
<body onload="SetMenu()">

<table width="100%" cellpadding="0" cellspacing="0">
  <tr width="100%">
    <td id="cell-0-0" colspan="2">&nbsp;</td>
    <td id="cell-0-1">&nbsp;</td>
    <td id="cell-0-2" colspan="2">&nbsp;</td>
  </tr>
  <tr width="100%">
    <td id="cell-1-0">&nbsp;</td>
    <td id="cell-1-1">&nbsp;</td>
    <td id="cell-1-2">
      <div style="padding: 5px;">
        <div id="banner">
          <!-- Banner -->
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
        <tr>
          <td align="left" class="topbardiv" nowrap="">
            <a href="http://aries.apache.org/" title="Apache Aries"> <img border="0" src="http://aries.apache.org/images/Arieslogo_Horizontal.gif"> </a>
          </td>
          <td align="right" nowrap="">
            <a href="http://www.apache.org/" title="The Apache Software Foundation"> <img border="0" src="http://aries.apache.org/images/apache_feather.png"> </a>
              </td>
        </tr>
      </table>
          <!-- Banner -->
        </div>
      </div>
      <div id="top-menu">
        <table border="0" cellpadding="1" cellspacing="0" width="100%">
          <tr>
            <td>
              <div align="left">
                <!-- Breadcrumbs -->
                <!-- Breadcrumbs -->
              </div>
            </td>
            <td>
              <div align="right">
                <!-- Quicklinks -->
          <DIV style="padding: 5px 5px 0px 25px;">
            <FORM action="http://www.google.com/search" method="get" style="font-size: 10px;">
            <A href="http://www.apache.org/licenses/LICENSE-2.0.html" class="external-link" rel="nofollow">License</A> 
            <INPUT name="ie" type="hidden" value="UTF-8"></INPUT>
            <INPUT name="oe" type="hidden" value="UTF-8"></INPUT>
            <INPUT maxlength="255" name="q" size="15" type="text" value></INPUT>
            <INPUT name="btnG" type="submit" value="Search"></INPUT>
            <INPUT name="domains" type="hidden" value="aries.apache.org"></INPUT>
            <INPUT name="sitesearch" type="hidden" value="aries.apache.org"></INPUT>
            </FORM>
          </DIV>
                <!-- Quicklinks -->
              </div>
            </td>
          </tr>
        </table>
      </div>
    </td>
    <td id="cell-1-3">&nbsp;</td>
    <td id="cell-1-4">&nbsp;</td>
  </tr>
  <tr width="100%">
    <td id="cell-2-0" colspan="2">&nbsp;</td>
    <td id="cell-2-1">
      <table>
        <tr height="100%" valign="top">
          <td height="100%">
            <div id="wrapper-menu-page-right">
              <div id="wrapper-menu-page-top">
                <div id="wrapper-menu-page-bottom">
                  <div id="menu-page">
                    <!-- NavigationBar -->
          <div onclick="SwitchMenu('overview')" id="overviewTitle" class="menutitle">Overview</div>

<div id="overview" class="menuitemgroup">
    <div class="menuitem">
        <a href="/overview/boardreports.html">Board Reports</a> 
    </div>
    <div class="menuitem">
        <a href="/overview/news.html">News</a> 
    </div>
</div>

<div onclick="SwitchMenu('documentation')" id="documentationTitle" class="menutitle">Documentation</div>

<div id="documentation" class="menuitemgroup">
    <div class="menuitem">
        <a href="/documentation/ariesprogrammingmodel.html">Programming Model</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/pointerstoosgispecifications.html">Pointers to OSGi specs</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/integrators-guide.html">Integrators Guide</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/articles.html">Articles</a> 
    </div>
    <div class="menuitem">
        <a href="https://svn.apache.org/repos/asf/aries/slides/">Slides</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/tutorials.html">Tutorials</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/tools.html">Tools</a> 
    </div>
</div>

<div onclick="SwitchMenu('downloads')" id="downloadsTitle" class="menutitle">Downloads</div>

<div id="downloads" class="menuitemgroup">
    <div class="menuitem">
        <a href="/downloads/currentrelease.html">Current Release</a> 
    </div>
    <div class="menuitem">
        <a href="/downloads/testresults.html">Compliance Tests</a> 
    </div>
    <div class="menuitem">
        <a href="/downloads/archived-releases.html">Archived Releases</a> 
    </div>
</div>

<div onclick="SwitchMenu('community')" id="communityTitle" class="menutitle">Community</div>

<div id="community" class="menuitemgroup">
    <div class="menuitem">
        <a href="/community/overview.html">Community</a> 
    </div>
    <div class="menuitem">
        <a href="/community/gettinginvolved.html">Getting Involved</a> 
    </div>
    <div class="menuitem">
        <a href="/community/people.html">Who we are</a> 
    </div>
    <div class="menuitem">
        <a href="/community/mailinglists.html">Mailing lists</a> 
    </div>
        <div class="menuitem">
                <a href="/community/logos.html">Logos for Users</a>
        </div>
</div>

<div onclick="SwitchMenu('development')" id="developmentTitle" class="menutitle">Development</div>

<div id="development" class="menuitemgroup">
    <div class="menuitem">
        <a href="https://svn.apache.org/repos/asf/aries/">Source Control</a> 
    </div>
    <div class="menuitem">
        <a href="https://issues.apache.org/jira/browse/ARIES">Bug Tracking</a> 
    </div>
    <div class="menuitem">
        <a href="/development/buildingaries.html">Building Aries </a> 
    </div>
    <div class="menuitem">
        <a href="/development/maven-best-practice-in-aries.html">Maven best practice</a> 
    </div>
    <div class="menuitem">
        <a href="/development/moduledependencies.html">Module Dependencies</a> 
    </div>
    <div class="menuitem">
        <a href="/development/releasingaries.html">Releasing Aries </a> 
    </div>
    <div class="menuitem">
        <a href="/development/verifyingrelease.html">Verifying Release artifacts</a> 
    </div>
    <div class="menuitem">
        <a href="/development/compliancetesting.html">OSGi Compliance Tests </a> 
    </div>
    <div class="menuitem">
        <a href="https://builds.apache.org/hudson/">Build System</a> 
    </div>
    <div class="menuitem">
        <a href="/development/maintainingthewebpages.html">Web Site Maintenance </a> 
    </div>
        <div class="menuitem">
        <a href="/development/versionpolicy.html">OSGi Version Policy </a> 
    </div>
</div>

<div onclick="SwitchMenu('modules')" id="modulesTitle" class="menutitle">Modules</div>

<div id="modules" class="menuitemgroup">
    <div class="menuitem">
        <a href="/modules/samples.html">Samples</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/blueprint.html">Blueprint</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/blueprintannotation.html">Blueprint Annotations</a>
    </div>
    <div class="menuitem">
        <a href="/modules/blueprintnoosgi.html">Blueprint No-OSGi</a>
    </div>
    <div class="menuitem">
        <a href="/modules/blueprintweb.html">Blueprint Web</a>
    </div>
    <div class="menuitem">
        <a href="/modules/jmx.html">JMX</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/jndiproject.html">JNDI</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/jpaproject.html">JPA</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/applications.html">Applications</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/transactionsproject.html">Transactions</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/ebamavenpluginproject.html">EBA Maven Plugin </a> 
    </div>
    <div class="menuitem">
        <a href="/modules/spi-fly.html">SPI Fly</a> 
    </div>
</div>

<div onclick="SwitchMenu('sponsorship')" id="sponsorshipTitle" class="menutitle">Sponsorship</div>

<div id="sponsorship" class="menuitemgroup">
    <div class="menuitem">
        <a href="http://www.apache.org/foundation/thanks.html">Thanks</a> 
    </div>
    <div class="menuitem">
        <a href="http://www.apache.org/foundation/sponsorship.html">Sponsoring Apache</a> 
    </div>
</div>
                    <!-- NavigationBar -->
                  </div>
                </div>
              </div>
            </div>
          </td>
          <td height="100%" width="100%">
            <!-- Content -->
            <div class="wiki-content"><p>Title: JPAProject</p>
<h1 id="jpa">JPA</h1>
<p>The Aries JPA project will make it easy for JPA persistence providers such
as <a href="http://openjpa.apache.org/">Apache OpenJPA</a>
 to be used in an OSGi environment and will provide container managed
persistence for the Blueprint container.</p>
<p>For more information, check out section "127 JPA Service Specification
Version 1.0" in the "OSGi Service Platform Enterprise Specification,
Release 4, Version 4.2" available for public download from the <a href="http://www.osgi.org/Download/Release4V42">OSGi Alliance</a>
.</p>
<p>Developing an Aries JPA project is very easy and can be achieved with simple steps described in the 
"Creation of a JPA project using Maven" section. First, however it is useful to understand some of
the basic concepts.</p>
<h2 id="persistence-bundles">Persistence bundles</h2>
<p>The Aries JPA container provides managed JPA support in an OSGi framework for OSGi persistence bundles.
A persistence bundle is an OSGi bundle with three special characteristics:</p>
<ul>
<li>It contains one or more JPA mapped classes (Entity classes, Mapped superclasses and Embeddables)</li>
<li>It contains a JPA persistence descriptor describing one or more persistence units</li>
<li>The bundle manifest contains the header <strong>Meta-Persistence:</strong> </li>
</ul>
<p>The value of the Meta-Persistence: header is a comma separated list of locations where JPA persistence 
descriptors can be found. If the header value is empty then a default of META-INF/persistence.xml is used.
(This behaviour is taken from the JPA service specification).</p>
<p>For example:</p>
<div class="codehilite"><pre><span class="n">Meta</span><span class="o">-</span><span class="n">Persistence:</span>
</pre></div>


<p>means that META-INF/persistence.xml will be searched for. For non standard locations:</p>
<div class="codehilite"><pre><span class="n">Meta</span><span class="o">-</span><span class="n">Persistence:</span> <span class="n">persistence</span><span class="sr">/myPu.xml, pUnit.jar!/som</span><span class="n">eFolder</span><span class="o">/</span><span class="n">anotherPu</span><span class="o">.</span><span class="n">xml</span>
</pre></div>


<p>means that the locations "persistence/myPu.xml" (relative to the root of the bundle), and 
"someFolder/anotherPu.xml" (relative to the root of pUnit.jar, which is in the root of
the bundle) will be searched.</p>
<h2 id="the-aries-jpa-container">The Aries JPA container</h2>
<p>The Aries JPA container consists of four main pieces, the two most important of which are the API bundle
and the container bundle.</p>
<h3 id="the-aries-jpa-api-bundle">The Aries JPA API bundle</h3>
<p>The Aries JPA container API bundle is <strong>not</strong> the JPA API, it is a set of interfaces for interacting with
the Aries JPA container. Clients are unlikely to use this API, but you may need it if you are building
your own runtime. This bundle also defines the interfaces that the Aries JPA container bundles use to
talk to each other, as a result it is a mandatory dependency of all of the other Aries JPA container bundles.</p>
<h3 id="the-aries-jpa-container-bundle">The Aries JPA container bundle</h3>
<p>The Aries JPA container bundle provides basic support for application managed JPA. It is responsible for
locating and parsing persistence descriptors. Any persistence units found will be processed and used to
create EntityManagerFactory services, which will be registered on behalf of the persistence bundle when
it starts.</p>
<p>The EntityManagerFactory services will be registered with the following properties: </p>
<div class="codehilite"><pre><span class="n">osgi</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span> <span class="o">-</span> <span class="n">this</span> <span class="n">is</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">persistence</span> <span class="n">unit</span>
<span class="n">osgi</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">provider</span> <span class="o">-</span> <span class="n">this</span> <span class="n">is</span> <span class="n">the</span> <span class="n">class</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">JPA</span> <span class="n">PersistenceProvider</span> <span class="n">that</span> <span class="n">was</span> <span class="n">used</span> <span class="n">to</span> <span class="n">create</span> <span class="n">the</span> <span class="n">EntityManagerFactory</span>
<span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">aries</span><span class="o">.</span><span class="n">jpa</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">managed</span> <span class="o">-</span> <span class="n">this</span> <span class="n">property</span> <span class="n">will</span> <span class="n">be</span> <span class="n">set</span> <span class="n">to</span> <span class="n">true</span><span class="p">,</span> <span class="n">indicating</span> <span class="n">this</span> <span class="n">is</span> <span class="n">a</span> <span class="n">managed</span> <span class="n">EntityManagerFactory</span><span class="o">.</span>
</pre></div>


<p>Useful notes: </p>
<ul>
<li>
<p>Older versions of the Aries JPA container (below 0.4) do not support classpath scanning or load-time weaving, 
this means that you must list all of your entity classes in your persistence descriptor, and that you must 
pre-enhance your entities. This restriction does not apply to versions newer than 0.4 when running on OSGi
frameworks implementing version 4.3 of the OSGi specification.</p>
</li>
<li>
<p>You should never call close on the EntityManagerFactory service. This call will be made by the container when
the persistence bundle is removed or refreshed. If you do close the EntityManagerFactory service then it will be 
closed for <strong>all</strong> users of the service.</p>
</li>
</ul>
<h3 id="the-aries-jpa-container-context-bundle">The Aries JPA container context bundle</h3>
<p>This bundle provides managed persistence context support. In order to function it requires the Aries JPA container
bundle to be running as it makes use of the managed EntityManagerFactory services.</p>
<p>This bundle also depends on the presence of a JTA service specification implementation, as it makes use of the
TransactionSynchronizationRegistry service.</p>
<p>It is unlikely that clients will use this bundle directly. To actually use managed persistence contexts a client
should use blueprint to inject one.</p>
<h2 id="the-aries-jpa-container-blueprint-integration-bundle">The Aries JPA container blueprint integration bundle</h2>
<p>This bundle provides a blueprint custom namespace for persistence unit and persistence context injection. To
inject persistence units the Aries JPA container bundle is required. To inject persistence contexts the Aries
JPA container context bundle is also required.</p>
<p>Example blueprint follows showing the full breadth of allowable injection syntax:</p>
<div class="codehilite"><pre><span class="nt">&lt;blueprint</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;</span> 
  <span class="na">xmlns:jpa=</span><span class="s">&quot;http://aries.apache.org/xmlns/jpa/v1.1.0&quot;</span><span class="nt">&gt;</span>

  <span class="c">&lt;!-- Inject a persistence unit called &quot;myUnit&quot; using the bean property &quot;setEmf&quot; --&gt;</span>
  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;unit&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jpa:unit</span> <span class="na">property=</span><span class="s">&quot;emf&quot;</span> <span class="na">unitname=</span><span class="s">&quot;myUnit&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>

  <span class="c">&lt;!-- Inject an unnamed persistence unit using the bean property &quot;setEmf2&quot; --&gt;</span>
  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;unitNoName&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jpa:unit</span> <span class="na">property=</span><span class="s">&quot;emf2&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>

  <span class="c">&lt;!-- Inject a persistence unit with name &quot;&quot; using the bean property &quot;setEmf3&quot; --&gt;</span>
  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;emptyUnitName&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jpa:unit</span> <span class="na">property=</span><span class="s">&quot;emf3&quot;</span> <span class="na">unitname=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>

  <span class="c">&lt;!-- Inject a persistence context for the unit called &quot;myUnit&quot; using the bean property &quot;setEm&quot; --&gt;</span>
  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;context&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jpa:context</span> <span class="na">property=</span><span class="s">&quot;em&quot;</span> <span class="na">unitname=</span><span class="s">&quot;myUnit&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>

  <span class="c">&lt;!-- </span>
<span class="c">      Inject an Extended persistence context for an unnamed persistence unit that is constructed</span>
<span class="c">      passing in the supplied properties and injected using the bean property &quot;setEm&quot; </span>
<span class="c">  --&gt;</span>
  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;contextWithProps&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jpa:context</span> <span class="na">property=</span><span class="s">&quot;em&quot;</span> <span class="na">type=</span><span class="s">&quot;EXTENDED&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;map&gt;</span>
        <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;one&quot;</span> <span class="na">value=</span><span class="s">&quot;eins&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;two&quot;</span> <span class="na">value=</span><span class="s">&quot;zwo&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/jpa:context&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>

  <span class="c">&lt;!-- Inject a persistence unit called &quot;myUnit&quot; using constructor injection --&gt;</span>
  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;withUnitArg&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jpa:unit</span> <span class="na">unitname=</span><span class="s">&quot;myUnit&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>

  <span class="c">&lt;!-- Inject a persistence context using the unit called &quot;myUnit&quot; using constructor injection --&gt;</span>
  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;withContextArg&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jpa:context</span> <span class="na">unitname=</span><span class="s">&quot;myUnit&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>

  <span class="c">&lt;!-- Inject a persistence unit called &quot;myUnit&quot; using constructor injection and argument index 0 --&gt;</span>
  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;withIndexedUnitArg&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jpa:unit</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">unitname=</span><span class="s">&quot;myUnit&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>

  <span class="c">&lt;!-- Inject a persistence context using the unit called &quot;myUnit&quot; using constructor injection and argument index 1 --&gt;</span>
  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;withIndexedContextArg&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jpa:context</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">unitname=</span><span class="s">&quot;myUnit&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/blueprint&gt;</span>
</pre></div>


<p>This blueprint namespace can be used by any blueprint bundle (not just the persistence bundle), and as the injection
occurs via the service registry your blueprint will not start until the relevant JPA resources are available there.</p>
<h1 id="creation-of-a-jpa-project-using-maven">Creation of a JPA project using Maven</h1>
<p>The first step consist in to create a maven module and make the following modifications to allow to deploy
 it as OSGI bundle on the platform and reference where the persistence XML file must loaded by the classpath to
 allow to the JPA container to configure the project accordingly.</p>
<p><strong>Step 1 : Module</strong></p>
<p>Every jar deployed on an OSGI platform must be adapted to be conform to OSGI standard. That means that the maven
packaging which is defined as the default value must be defined to bundle</p>
<div class="codehilite"><pre><span class="nt">&lt;groupId&gt;</span>org.apache.aries.samples.blog<span class="nt">&lt;/groupId&gt;</span>
<span class="nt">&lt;artifactId&gt;</span>org.apache.aries.samples.blog.persistence.jpa<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;name&gt;</span>Apache Aries blog sample persistence<span class="nt">&lt;/name&gt;</span>
<span class="nt">&lt;packaging&gt;</span>bundle<span class="nt">&lt;/packaging&gt;</span>
</pre></div>


<p>and that you must configure the maven-bundle-plugin (http://felix.apache.org/site/apache-felix-maven-bundle-plugin-bnd.html)
to generate the MANIFEST.MF file required by OSGI platform.</p>
<p>Remark : the modification to be made (packages to be imported or exported depends on your project setting)</p>
<div class="codehilite"><pre><span class="nt">&lt;plugin&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.felix<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>maven-bundle-plugin<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;configuration&gt;</span>
        <span class="nt">&lt;instructions&gt;</span>
            <span class="nt">&lt;Bundle</span><span class="err">-SymbolicName</span><span class="nt">&gt;</span><span class="cp">${</span><span class="n">project</span><span class="o">.</span><span class="n">artifactId</span><span class="cp">}</span><span class="nt">&lt;/Bundle-SymbolicName&gt;</span>
            <span class="nt">&lt;Private</span><span class="err">-Package</span><span class="nt">&gt;</span>org.apache.aries.samples.blog.persistence.jpa.*<span class="nt">&lt;/Private-Package&gt;</span>
            <span class="nt">&lt;Export</span><span class="err">-Package</span><span class="nt">&gt;</span>!org.apache.aries.samples.blog.persistence.jpa.*<span class="nt">&lt;/Export-Package&gt;</span>
        <span class="nt">&lt;/instructions&gt;</span>
    <span class="nt">&lt;/configuration&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</pre></div>


<p>To allow the Aries JPA Container to setup your persistence layer (akka : instantiate the entityFactory with the information
provided into the persistence.xml file), an additional modification must be made in your pom.xml file to package this file
into the META-INF directory</p>
<div class="codehilite"><pre><span class="nt">&lt;plugin&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.felix<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>maven-bundle-plugin<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;configuration&gt;</span>
        <span class="nt">&lt;instructions&gt;</span>
            <span class="nt">&lt;Meta-Persistence&gt;</span>META-INF/persistence.xml<span class="nt">&lt;/Meta-Persistence&gt;</span>
            ...
        <span class="nt">&lt;/instructions&gt;</span>
    <span class="nt">&lt;/configuration&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</pre></div>


<p>When this step is done, your pom.xml file is ready to be used to package and install your bundle into the maven repository
and next into a OSGI container (Apache Felix, Apache Karaf, Eclipse Equinox)</p>
<p><strong>Step 2 : Adapt the persistence file</strong></p>
<p>We will not cover how to define the different parameters of the persistence file but present you what you should modify to
deploy it on non J2EE platform, which is the case by definition for OSGI kernel. Curiously, there is only one think
to modify and it concerns the access to the datasource. In J2EE world, we use JNDI as registry mecahnism to registry
the datasource with a key used to find it from applications. JNDI is not supported like that in OSGI world but OSGI EE
specification has made a proposition to provide a similar mechanism that Aries JNDI project covers (http://aries.apache.org/modules/jndiproject.html).</p>
<p>To access to the datasource, you must provide within the <jta-data-source> or <non-jta-data-source> depending if you use a JTA
transaction manager or not.</p>
<div class="codehilite"><pre><span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">&quot;ReportIncident&quot;</span> <span class="na">transaction-type=</span><span class="s">&quot;JTA&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;provider&gt;</span>org.apache.openjpa.persistence.PersistenceProviderImpl<span class="nt">&lt;/provider&gt;</span>

<span class="nt">&lt;jta-data-source&gt;</span>osgi:service/javax.sql.DataSource/(osgi.jndi.service.name=jdbc/reportincidentdb)<span class="nt">&lt;/jta-data-source&gt;</span>
</pre></div>


<p>With J2EE applications, you simply use the jdbc key with the name of the datasource associated (jdbc/reportincidentdb). As OSGI uses a
 different mechanism, we must define two parameters, the "osgi:service" wich will allow to find from the OSGI Service registry (aka proxy)
 the interface "javax.sql.DataSource" and the name of the service "osgi.jndi.service.name", which is a filter property,  with its jndi name associated.</p>
<p>The other tags of the xml file are defined according to JPA specification</p>
<p><strong>Step 3 : Define the services and expose them</strong></p>
<p>The last step consist in to use Annotations and Injection mechanism to let the Aries JPA container to create the entity Manager
with the classes of your DAO layer and add Transactional aspect into the methods. This way of work allows to complety
embed existing projects into ARIES sphere without modifications</p>
<p>Here are the modifications to do in the blueprint xml file located under OSGI-INF/blueprint</p>
<p><blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:tx="http://aries.apache.org/xmlns/transactions/v1.0.0"
    xmlns:jpa="http://aries.apache.org/xmlns/jpa/v1.0.0"
    default-activation="lazy"></p>
<div class="codehilite"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;incidentDAO&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.apache.camel.example.reportincident.dao.impl.IncidentDAOImpl&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tx:transaction</span> <span class="na">method=</span><span class="s">&quot;*&quot;</span> <span class="na">value=</span><span class="s">&quot;Required&quot;</span> <span class="nt">/&gt;</span> (1)
    <span class="nt">&lt;jpa:context</span> <span class="na">property=</span><span class="s">&quot;entityManager&quot;</span> <span class="na">unitname=</span><span class="s">&quot;ReportIncident&quot;</span> <span class="nt">/&gt;</span> (2)
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;service</span> <span class="na">ref=</span><span class="s">&quot;incidentDAO&quot;</span>
    <span class="na">interface=</span><span class="s">&quot;org.apache.camel.example.reportincident.dao.IncidentDAO&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/service&gt;</span>

<span class="c">&lt;!-- DataSource Derby --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSourceDerby&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span> <span class="na">destroy-method=</span><span class="s">&quot;close&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driverClassName&quot;</span> <span class="na">value=</span><span class="s">&quot;org.apache.derby.jdbc.EmbeddedDriver&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;jdbc:derby:/temp/reportincident;create=true&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- Expose DataSource as JNDI reference --&gt;</span>
<span class="nt">&lt;service</span> <span class="na">ref=</span><span class="s">&quot;dataSourceDerby&quot;</span> <span class="na">interface=</span><span class="s">&quot;javax.sql.DataSource&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;service-properties&gt;</span>
     <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;osgi.jndi.service.name&quot;</span> <span class="na">value=</span><span class="s">&quot;jdbc/reportincidentdb&quot;</span><span class="nt">/&gt;</span> (3)
   <span class="nt">&lt;/service-properties&gt;</span>
<span class="nt">&lt;/service&gt;</span>
</pre></div>


<p></blueprint></p>
<p>(1) The &lt;tx:transaction&gt; tag allows to inject in your DAO layer the transactional aspect and using the following symbol
"*", Aries Transaction manager will create for each method a session to begin / commit or rollback a transaction in your class
The scope of the transaction can be defined using the attribute value.<br />
(2) The JPA context is created using &lt;jpa:context&gt;. The entityManager (which corresponds to the property of your DAO class) will be
injected using the property="entityManager". The reference to your unit name (defined in the persistence.xml file) is passed with the
 attribute unitname.
file.<br />
(3) The &lt;service&gt; allows to expose an interface on the OSGI Registry Service using as key the name of the interface ("javax,sql.Datasource").
The &lt;service-properties&gt; will let to define a property that we will use to retrieve the datasource from the registry</p>
<p><strong>Step 4 : Package the solution</strong></p>
<p>To package and deploy the solution, execute a "maven clean install" instruction and deploy your project into your favorite OSGI platform. Depending in which OSGI container
you plan to deploy your projects, the bundles (Aries JPA, OpenJPA, Aries Transaction, ....) to be used will be
different and you will have to identify them. The Aries samples project provides you a list of <a href="https://svn.apache.org/repos/asf/aries/trunk/samples/blog/blog-itests/src/test/java/org/apache/aries/samples/blog/itests/JpaBlogSampleWithEbaTest.java">bundles</a> and you 
can use them as a starting point to create your first project.</p></div>
            <!-- Content -->
          </td>
        </tr>
      </table>
   </td>
   <td id="cell-2-2" colspan="2">&nbsp;</td>
  </tr>
  <tr width="100%">
   <td id="cell-3-0">&nbsp;</td>
   <td id="cell-3-1">&nbsp;</td>
   <td id="cell-3-2">
     <div id="footer">
       <!-- Footer -->
       <div id="site-footer">
         <a href="http://aries.apache.org/privacy-policy.html";>Privacy
Policy</a> 
       </div>
       <!-- Footer -->
     </div>
   </td>
   <td id="cell-3-3">&nbsp;</td>
   <td id="cell-3-4">&nbsp;</td>
  </tr>
  <tr width="100%">
    <td id="cell-4-0" colspan="2">&nbsp;</td>
    <td id="cell-4-1">&nbsp;</td>
    <td id="cell-4-2" colspan="2">&nbsp;</td>
  </tr>
</table>
</body>
</html> 
