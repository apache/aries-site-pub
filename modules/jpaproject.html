<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd";>
<!--
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements. See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License. You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<html>
  <head>
    <link type="text/css" rel="stylesheet" href="http://aries.apache.org/resources/site.css"></link>
    </script><script src="http://aries.apache.org/resources/menus.js" language="javascript" type="text/javascript"></script>
	<meta name="keywords" content="..."/>
	<meta name="description" content="..." />
    <title>
		Apache Aries - JPAProject
    </title>
  </head>
<body onload="SetMenu()">

<table width="100%" cellpadding="0" cellspacing="0">
  <tr width="100%">
    <td id="cell-0-0" colspan="2">&nbsp;</td>
    <td id="cell-0-1">&nbsp;</td>
    <td id="cell-0-2" colspan="2">&nbsp;</td>
  </tr>
  <tr width="100%">
    <td id="cell-1-0">&nbsp;</td>
    <td id="cell-1-1">&nbsp;</td>
    <td id="cell-1-2">
      <div style="padding: 5px;">
        <div id="banner">
          <!-- Banner -->
			<table border="0" cellpadding="0" cellspacing="0" width="100%">
				<tr>
					<td align="left" class="topbardiv" nowrap="">
						<a href="http://aries.apache.org/" title="Apache Aries"> <img border="0" src="http://aries.apache.org/images/Arieslogo_Horizontal.gif"> </a>
					</td>
					<td align="right" nowrap="">
						<a href="http://www.apache.org/" title="The Apache Software Foundation"> <img border="0" src="http://aries.apache.org/images/apache_feather.png"> </a>
      				</td>
				</tr>
			</table>
          <!-- Banner -->
        </div>
      </div>
      <div id="top-menu">
        <table border="0" cellpadding="1" cellspacing="0" width="100%">
          <tr>
            <td>
              <div align="left">
                <!-- Breadcrumbs -->
                <!-- Breadcrumbs -->
              </div>
            </td>
            <td>
              <div align="right">
                <!-- Quicklinks -->
					<DIV style="padding: 5px 5px 0px 25px;">
						<FORM action="http://www.google.com/search" method="get" style="font-size: 10px;">
						<A href="http://www.apache.org/licenses/LICENSE-2.0.html" class="external-link" rel="nofollow">License</A> 
						<INPUT name="ie" type="hidden" value="UTF-8"></INPUT>
						<INPUT name="oe" type="hidden" value="UTF-8"></INPUT>
						<INPUT maxlength="255" name="q" size="15" type="text" value></INPUT>
						<INPUT name="btnG" type="submit" value="Search"></INPUT>
						<INPUT name="domains" type="hidden" value="aries.apache.org"></INPUT>
						<INPUT name="sitesearch" type="hidden" value="aries.apache.org"></INPUT>
						</FORM>
					</DIV>
                <!-- Quicklinks -->
              </div>
            </td>
          </tr>
        </table>
      </div>
    </td>
    <td id="cell-1-3">&nbsp;</td>
    <td id="cell-1-4">&nbsp;</td>
  </tr>
  <tr width="100%">
    <td id="cell-2-0" colspan="2">&nbsp;</td>
    <td id="cell-2-1">
      <table>
        <tr height="100%" valign="top">
          <td height="100%">
            <div id="wrapper-menu-page-right">
              <div id="wrapper-menu-page-top">
                <div id="wrapper-menu-page-bottom">
                  <div id="menu-page">
                    <!-- NavigationBar -->
					<div onclick="SwitchMenu('overview')" id="overviewTitle" class="menutitle">Overview</div>
<div id="overview" class="menuitemgroup">
    <div class="menuitem">
        <a href="/overview/boardreports.html">Board Reports</a> 
    </div>
    <div class="menuitem">
        <a href="/overview/news.html">News</a> 
    </div>
</div>
<div onclick="SwitchMenu('documentation')" id="documentationTitle" class="menutitle">Documentation</div>
<div id="documentation" class="menuitemgroup">
    <div class="menuitem">
        <a href="/documentation/ariesprogrammingmodel.html">Programming Model</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/pointerstoosgispecifications.html">Pointers to OSGi specs</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/integrators-guide.html">Integrators Guide</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/articles.html">Articles</a> 
    </div>
    <div class="menuitem">
        <a href="https://svn.apache.org/repos/asf/aries/slides/">Slides</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/tutorials.html">Tutorials</a> 
    </div>
</div>
<div onclick="SwitchMenu('downloads')" id="downloadsTitle" class="menutitle">Downloads</div>
<div id="downloads" class="menuitemgroup">
    <div class="menuitem">
        <a href="/downloads/currentrelease.html">Current Release</a> 
    </div>
    <div class="menuitem">
        <a href="/downloads/testresults.html">Compliance Tests</a> 
    </div>
    <div class="menuitem">
        <a href="/downloads/releasenotes.html">Release Notes</a> 
    </div>
    <div class="menuitem">
        <a href="/downloads/archived-releases.html">Archived Releases</a> 
    </div>
</div>
<div onclick="SwitchMenu('community')" id="communityTitle" class="menutitle">Community</div>
<div id="community" class="menuitemgroup">
    <div class="menuitem">
        <a href="/community/overview.html">Community</a> 
    </div>
    <div class="menuitem">
        <a href="/community/gettinginvolved.html">Getting Involved</a> 
    </div>
    <div class="menuitem">
        <a href="/community/people.html">Who we are</a> 
    </div>
    <div class="menuitem">
        <a href="/community/mailinglists.html">Mailing lists</a> 
    </div>
    <div class="menuitem">
        <a href="http://blogs.apache.org/aries/">Aries Group Blog</a> 
    </div>
</div>
<div onclick="SwitchMenu('development')" id="developmentTitle" class="menutitle">Development</div>
<div id="development" class="menuitemgroup">
    <div class="menuitem">
        <a href="https://svn.apache.org/repos/asf/aries/">Source Control</a> 
    </div>
    <div class="menuitem">
        <a href="https://issues.apache.org/jira/browse/ARIES">Bug Tracking</a> 
    </div>
    <div class="menuitem">
        <a href="/development/buildingaries.html">Building Aries </a> 
    </div>
    <div class="menuitem">
        <a href="/development/maven-best-practice-in-aries.html">Maven best practice</a> 
    </div>
    <div class="menuitem">
        <a href="/development/moduledependencies.html">Module Dependencies</a> 
    </div>
    <div class="menuitem">
        <a href="/development/releasingaries.html">Releasing Aries </a> 
    </div>
    <div class="menuitem">
        <a href="/development/compliancetesting.html">OSGi Compliance Tests </a> 
    </div>
    <div class="menuitem">
        <a href="http://hudson.zones.apache.org/hudson/">Build System</a> 
    </div>
    <div class="menuitem">
        <a href="/development/maintainingthewebpages.html">Web Site Maintenance </a> 
    </div>
</div>
<div onclick="SwitchMenu('modules')" id="modulesTitle" class="menutitle">Modules</div>
<div id="modules" class="menuitemgroup">
    <div class="menuitem">
        <a href="/modules/samples.html">Samples</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/blueprint.html">Blueprint</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/jndiproject.html">JNDI</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/jpaproject.html">JPA</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/applications.html">Applications</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/transactionsproject.html">Transactions</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/ebamavenpluginproject.html">EBA Maven Plugin </a> 
    </div>
    <div class="menuitem">
        <a href="/modules/spi-fly.html">SPI Fly</a> 
    </div>
</div>
<div onclick="SwitchMenu('sponsorship')" id="sponsorshipTitle" class="menutitle">Sponsorship</div>
<div id="sponsorship" class="menuitemgroup">
    <div class="menuitem">
        <a href="http://www.apache.org/foundation/thanks.html">Thanks</a> 
    </div>
    <div class="menuitem">
        <a href="http://www.apache.org/foundation/sponsorship.html">Sponsoring Apache</a> 
    </div>
</div>
                    <!-- NavigationBar -->
                  </div>
                </div>
              </div>
            </div>
          </td>
          <td height="100%" width="100%">
            <!-- Content -->
            <div class="wiki-content"><h1 id="jpa">JPA</h1>
<p>The Aries JPA project will make it easy for JPA persistence providers such
as <a href="http://openjpa.apache.org/">Apache OpenJPA</a>
 to be used in an OSGi environment and will provide container managed
persistence for the Blueprint container.</p>
<p>For more information, check out section "127 JPA Service Specification
Version 1.0" in the "OSGi Service Platform Enterprise Specification,
Release 4, Version 4.2" available for public download from the <a href="http://www.osgi.org/Download/Release4V42">OSGi Alliance</a>
.</p>
<p>Developing an Aries JPA project is very easy and can be achieved with simple steps described hereafter.</p>
<h1 id="maven_project_creation">Maven Project Creation</h1>
<p>The first step consist in to create a maven module and make the following modifications to allow to deploy
 it as OSGI bundle on the platform and reference where the persistence XML file must loaded by the classpath to
 allow to the JPA container to configure the project accordingly.</p>
<p>Step 1 : Module</p>
<p>Every jar deployed on an OSGI platform must be adapted to be conform to OSGI standard. That means that the maven
packaging which is defined as the default value must be defined to bundle</p>
<p>{code}
    <groupId>org.apache.aries.samples.blog</groupId>
    <artifactId>org.apache.aries.samples.blog.persistence.jpa</artifactId>
    <name>Apache Aries blog sample persistence</name>
    <packaging>bundle</packaging>
{code} </p>
<p>and that you must configure the maven-bundle-plugin (http://felix.apache.org/site/apache-felix-maven-bundle-plugin-bnd.html)
to generate the MANIFEST.MF file required by OSGI platform.</p>
<p>Remark : the modification to be made (packages to be imported or exported depends on your project setting)</p>
<p>{code}
    <plugin>
        <groupId>org.apache.felix</groupId>
        <artifactId>maven-bundle-plugin</artifactId>
        <configuration>
            <instructions>
                <Bundle-SymbolicName>${pom.artifactId}</Bundle-SymbolicName>
                <Private-Package>org.apache.aries.samples.blog.persistence.jpa.<em></Private-Package>
                <Export-Package>!org.apache.aries.samples.blog.persistence.jpa.</em></Export-Package>
            </instructions>
        </configuration>
    </plugin>
{code}</p>
<p>To allow the Aries JPA Container to setup your persistence layer (akka : instantiate the entityFactory with the information
provided into the persistence.xml file), an additional modification must be made in your pom.xml file to package this file
into the META-INF directory</p>
<p>{code}
    <plugin>
        <groupId>org.apache.felix</groupId>
        <artifactId>maven-bundle-plugin</artifactId>
        <configuration>
            <instructions>
                <Meta-Persistence>META-INF/persistence.xml</Meta-Persistence>
                ...
            </instructions>
        </configuration>
    </plugin>
{code}</p>
<p>When this step is done, your pom.xml file is ready to be used to package and install your bundle into the maven repository
and next into a OSGI container (Apache Felix, Apache Karaf, Eclipse Equinox)</p>
<p>Step 2 : Adapt the persistence file</p>
<p>We will not cover how to define the different parameters of the persistence file but present you what you should modify to
deploy it on non J2EE platform, which is the case by definition for OSGI kernel. Curiously, there is only one think
to modify and it concerns the access to the datasource. In J2EE world, we use JNDI as registry mecahnism to registry
the datasource with a key used to find it from applications. JNDI is not supported like that in OSGI world but OSGI EE
specification has made a proposition to provide a similar mechanism that Aries JNDI project covers (http://aries.apache.org/modules/jndiproject.html).</p>
<p>To access to the datasource, you must provide within the <jta-data-source> or <non-jta-data-source> depending if you use a JTA
transaction manager or not.</p>
<p>{code}
    <persistence-unit name="ReportIncident" transaction-type="JTA">
        <provider>org.apache.openjpa.persistence.PersistenceProviderImpl</provider></p>
<div class="codehilite"><pre>    <span class="nt">&lt;jta-data-source&gt;</span>osgi:service/javax.sql.DataSource/(osgi.jndi.service.name=jdbc/reportincidentdb)<span class="nt">&lt;/jta-data-source&gt;</span>
</pre></div>


<p>{code}</p>
<p>With J2EE applications, you simply use the jdbc key with the name of the datasource associated (jdbc/reportincidentdb). As OSGI uses a
 different mechanism, we must define two parameters, the "osgi:service" wich will allow to find from the OSGI Service registry (aka proxy)
 the interface "javax.sql.DataSource" and the name of the service "osgi.jndi.service.name", which is a filter property,  with its jndi name associated.</p>
<p>The other tags of the xml file are defined according to JPA specification</p>
<p>Step 3 : Define the services and expose them</p>
<p>The last step consist in to use Annotations and Injection mechanism to let the Aries JPA container to create the entity Manager
with the classes of your DAO layer and add Transactional aspect into the methods. This way of work allows to complety
embed existing projects into ARIES sphere without modifications</p>
<p>Here are the modifications to do in the blueprint xml file located under OSGI-INF/blueprint</p>
<p>{code}
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:tx="http://aries.apache.org/xmlns/transactions/v1.0.0"
    xmlns:jpa="http://aries.apache.org/xmlns/jpa/v1.0.0"
    default-activation="lazy"></p>
<div class="codehilite"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;incidentDAO&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.apache.camel.example.reportincident.dao.impl.IncidentDAOImpl&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tx:transaction</span> <span class="na">method=</span><span class="s">&quot;*&quot;</span> <span class="na">value=</span><span class="s">&quot;Required&quot;</span> <span class="nt">/&gt;</span> (1)
    <span class="nt">&lt;jpa:context</span> <span class="na">property=</span><span class="s">&quot;entityManager&quot;</span> <span class="na">unitname=</span><span class="s">&quot;ReportIncident&quot;</span> <span class="nt">/&gt;</span> (2)
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;service</span> <span class="na">ref=</span><span class="s">&quot;incidentDAO&quot;</span>
    <span class="na">interface=</span><span class="s">&quot;org.apache.camel.example.reportincident.dao.IncidentDAO&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/service&gt;</span>

<span class="c">&lt;!-- DataSource Derby --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSourceDerby&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span> <span class="na">destroy-method=</span><span class="s">&quot;close&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driverClassName&quot;</span> <span class="na">value=</span><span class="s">&quot;org.apache.derby.jdbc.EmbeddedDriver&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;jdbc:derby:/temp/reportincident;create=true&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- Expose DataSource as JNDI reference --&gt;</span>
<span class="nt">&lt;service</span> <span class="na">ref=</span><span class="s">&quot;dataSourceDerby&quot;</span> <span class="na">interface=</span><span class="s">&quot;javax.sql.DataSource&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;service-properties&gt;</span>
     <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;osgi.jndi.service.name&quot;</span> <span class="na">value=</span><span class="s">&quot;jdbc/reportincidentdb&quot;</span><span class="nt">/&gt;</span> (3)
   <span class="nt">&lt;/service-properties&gt;</span>
<span class="nt">&lt;/service&gt;</span>
</pre></div>


<p></blueprint>
{code}</p>
<p>(1) The <tx:transaction> tag allows to inject in your DAO layer the transactional aspect and using the following symbol
"*", Aries Transaction manager will create for each method a session to begin / commit or rollback a transaction in your class
The scope of the transaction can be defined using the attribute value.
(2) The JPA context is created using <jpa:context>. The entityManager (which corresponds to the property of your DAO class) will be
injected using the property="entityManager". The reference to your unit name (defined in the persistence.xml file) is passed with the
 attribute unitname.
file.
(3) The <service> allows to expose an interface on the OSGI Registry Service using as key the name of the interface ("javax,sql.Datasource").
The <service-properties> will let to define a property that we will use to retrieve the datasource from the registry</p>
<p>Step 4 : Package the solution</p>
<p>To package and deploy the solution, execute a "maven clean install" instruction and deploy your project on you OSGI platform</p></div>
            <!-- Content -->
          </td>
        </tr>
      </table>
   </td>
   <td id="cell-2-2" colspan="2">&nbsp;</td>
  </tr>
  <tr width="100%">
   <td id="cell-3-0">&nbsp;</td>
   <td id="cell-3-1">&nbsp;</td>
   <td id="cell-3-2">
     <div id="footer">
       <!-- Footer -->
       <div id="site-footer">
         <a href="http://aries.apache.org/privacy-policy.html";>Privacy
Policy</a> 
       </div>
       <!-- Footer -->
     </div>
   </td>
   <td id="cell-3-3">&nbsp;</td>
   <td id="cell-3-4">&nbsp;</td>
  </tr>
  <tr width="100%">
    <td id="cell-4-0" colspan="2">&nbsp;</td>
    <td id="cell-4-1">&nbsp;</td>
    <td id="cell-4-2" colspan="2">&nbsp;</td>
  </tr>
</table>
</body>
</html> 
