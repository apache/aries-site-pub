<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd";>
<!--
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements. See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License. You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<html>
  <head>
    <link rel="shortcut icon" href="http://aries.apache.org/images/favicon.ico"></link>
    <link type="text/css" rel="stylesheet" href="http://aries.apache.org/resources/site.css"></link>
    </script><script src="http://aries.apache.org/resources/menus.js" language="javascript" type="text/javascript"></script>
  <meta name="keywords" content="..."/>
  <meta name="description" content="..." />
    <title>
    Apache Aries - SPI Fly
    </title>
  </head>
<body onload="SetMenu()">

<table width="100%" cellpadding="0" cellspacing="0">
  <tr width="100%">
    <td id="cell-0-0" colspan="2">&nbsp;</td>
    <td id="cell-0-1">&nbsp;</td>
    <td id="cell-0-2" colspan="2">&nbsp;</td>
  </tr>
  <tr width="100%">
    <td id="cell-1-0">&nbsp;</td>
    <td id="cell-1-1">&nbsp;</td>
    <td id="cell-1-2">
      <div style="padding: 5px;">
        <div id="banner">
          <!-- Banner -->
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
        <tr>
          <td align="left" class="topbardiv" nowrap="">
            <a href="http://aries.apache.org/" title="Apache Aries"> <img border="0" src="http://aries.apache.org/images/Arieslogo_Horizontal.gif"> </a>
          </td>
          <td align="right" nowrap="">
            <a href="http://www.apache.org/" title="The Apache Software Foundation"> <img border="0" src="http://aries.apache.org/images/apache_feather.png"> </a>
              </td>
        </tr>
      </table>
          <!-- Banner -->
        </div>
      </div>
      <div id="top-menu">
        <table border="0" cellpadding="1" cellspacing="0" width="100%">
          <tr>
            <td>
              <div align="left">
                <!-- Breadcrumbs -->
                <!-- Breadcrumbs -->
              </div>
            </td>
            <td>
              <div align="right">
                <!-- Quicklinks -->
          <DIV style="padding: 5px 5px 0px 25px;">
            <FORM action="http://www.google.com/search" method="get" style="font-size: 10px;">
            <A href="http://www.apache.org/licenses/LICENSE-2.0.html" class="external-link" rel="nofollow">License</A> 
            <INPUT name="ie" type="hidden" value="UTF-8"></INPUT>
            <INPUT name="oe" type="hidden" value="UTF-8"></INPUT>
            <INPUT maxlength="255" name="q" size="15" type="text" value></INPUT>
            <INPUT name="btnG" type="submit" value="Search"></INPUT>
            <INPUT name="domains" type="hidden" value="aries.apache.org"></INPUT>
            <INPUT name="sitesearch" type="hidden" value="aries.apache.org"></INPUT>
            </FORM>
          </DIV>
                <!-- Quicklinks -->
              </div>
            </td>
          </tr>
        </table>
      </div>
    </td>
    <td id="cell-1-3">&nbsp;</td>
    <td id="cell-1-4">&nbsp;</td>
  </tr>
  <tr width="100%">
    <td id="cell-2-0" colspan="2">&nbsp;</td>
    <td id="cell-2-1">
      <table>
        <tr height="100%" valign="top">
          <td height="100%">
            <div id="wrapper-menu-page-right">
              <div id="wrapper-menu-page-top">
                <div id="wrapper-menu-page-bottom">
                  <div id="menu-page">
                    <!-- NavigationBar -->
          <div onclick="SwitchMenu('overview')" id="overviewTitle" class="menutitle">Overview</div>
<div id="overview" class="menuitemgroup">
    <div class="menuitem">
        <a href="/overview/boardreports.html">Board Reports</a> 
    </div>
    <div class="menuitem">
        <a href="/overview/news.html">News</a> 
    </div>
</div>
<div onclick="SwitchMenu('documentation')" id="documentationTitle" class="menutitle">Documentation</div>
<div id="documentation" class="menuitemgroup">
    <div class="menuitem">
        <a href="/documentation/ariesprogrammingmodel.html">Programming Model</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/pointerstoosgispecifications.html">Pointers to OSGi specs</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/integrators-guide.html">Integrators Guide</a> 
    </div>
        <div class="menuitem">
                <a href="/documentation/javadoc.html">Javadoc</a>
        </div>
    <div class="menuitem">
        <a href="/documentation/articles.html">Articles</a> 
    </div>
    <div class="menuitem">
        <a href="https://svn.apache.org/repos/asf/aries/slides/">Slides</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/tutorials.html">Tutorials</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/tools.html">Tools</a> 
    </div>
</div>
<div onclick="SwitchMenu('downloads')" id="downloadsTitle" class="menutitle">Downloads</div>
<div id="downloads" class="menuitemgroup">
    <div class="menuitem">
        <a href="/downloads/currentrelease.html">Current Release</a> 
    </div>
    <div class="menuitem">
        <a href="/downloads/testresults.html">Compliance Tests</a> 
    </div>
    <div class="menuitem">
        <a href="/downloads/releasenotes.html">Release Notes</a> 
    </div>
    <div class="menuitem">
        <a href="/downloads/archived-releases.html">Archived Releases</a> 
    </div>
</div>
<div onclick="SwitchMenu('community')" id="communityTitle" class="menutitle">Community</div>
<div id="community" class="menuitemgroup">
    <div class="menuitem">
        <a href="/community/overview.html">Community</a> 
    </div>
    <div class="menuitem">
        <a href="/community/gettinginvolved.html">Getting Involved</a> 
    </div>
    <div class="menuitem">
        <a href="/community/people.html">Who we are</a> 
    </div>
    <div class="menuitem">
        <a href="/community/mailinglists.html">Mailing lists</a> 
    </div>
    <div class="menuitem">
        <a href="http://blogs.apache.org/aries/">Aries Group Blog</a> 
    </div>
        <div class="menuitem">
                <a href="/community/logos.html">Logos for Users</a>
        </div>
</div>
<div onclick="SwitchMenu('development')" id="developmentTitle" class="menutitle">Development</div>
<div id="development" class="menuitemgroup">
    <div class="menuitem">
        <a href="https://svn.apache.org/repos/asf/aries/">Source Control</a> 
    </div>
    <div class="menuitem">
        <a href="https://issues.apache.org/jira/browse/ARIES">Bug Tracking</a> 
    </div>
    <div class="menuitem">
        <a href="/development/buildingaries.html">Building Aries </a> 
    </div>
    <div class="menuitem">
        <a href="/development/maven-best-practice-in-aries.html">Maven best practice</a> 
    </div>
    <div class="menuitem">
        <a href="/development/moduledependencies.html">Module Dependencies</a> 
    </div>
    <div class="menuitem">
        <a href="/development/releasingaries.html">Releasing Aries </a> 
    </div>
    <div class="menuitem">
        <a href="/development/compliancetesting.html">OSGi Compliance Tests </a> 
    </div>
    <div class="menuitem">
        <a href="https://builds.apache.org/hudson/">Build System</a> 
    </div>
    <div class="menuitem">
        <a href="/development/maintainingthewebpages.html">Web Site Maintenance </a> 
    </div>
        <div class="menuitem">
        <a href="/development/versionpolicy.html">OSGi Version Policy </a> 
    </div>
</div>
<div onclick="SwitchMenu('modules')" id="modulesTitle" class="menutitle">Modules</div>
<div id="modules" class="menuitemgroup">
    <div class="menuitem">
        <a href="/modules/samples.html">Samples</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/blueprint.html">Blueprint</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/jndiproject.html">JNDI</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/jpaproject.html">JPA</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/applications.html">Applications</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/transactionsproject.html">Transactions</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/ebamavenpluginproject.html">EBA Maven Plugin </a> 
    </div>
    <div class="menuitem">
        <a href="/modules/spi-fly.html">SPI Fly</a> 
    </div>
</div>
<div onclick="SwitchMenu('sponsorship')" id="sponsorshipTitle" class="menutitle">Sponsorship</div>
<div id="sponsorship" class="menuitemgroup">
    <div class="menuitem">
        <a href="http://www.apache.org/foundation/thanks.html">Thanks</a> 
    </div>
    <div class="menuitem">
        <a href="http://www.apache.org/foundation/sponsorship.html">Sponsoring Apache</a> 
    </div>
</div>
                    <!-- NavigationBar -->
                  </div>
                </div>
              </div>
            </div>
          </td>
          <td height="100%" width="100%">
            <!-- Content -->
            <div class="wiki-content"><h1 id="spi-fly">SPI-Fly</h1>
<p>This page describes the SPI Fly component.
The SPI Fly component is aimed at providing general support for the JRE SPI
mechanism (including the usage of META-INF/services) in OSGi.</p>
<p>The code can be found in
http://svn.apache.org/repos/asf/incubator/aries/trunk/spi-fly</p>
<p>Currently the implementation does the following:</p>
<p>Providers:</p>
<ul>
<li>It only considers provider bundles that have the following Manifest (opt-in)
header: <strong>SPI-Provider = </strong>*</li>
<li>For every new bundle being installed that has the opt-in header, it
checks the META-INF/services directory for any files. If found it registers
a service in the Service Registry for each implementation found with the
following property
 <em>spi.provider.url = <the URL to the associated META-INF/services file></em></li>
</ul>
<p>Consumers:</p>
<ul>
<li>It only considers consumer bundles that have the following Manifest (opt-in) header:
<strong>SPI-Consumer = </strong>*</li>
<li>When found, every call to java.util.ServiceLoader.load() will be modified automatically 
to have the ThreadContextClassLoader set to have visibility of the right bundles.</li>
</ul>
<h2 id="how_to_use">How to use</h2>
<p>There are currently two ways to use the SPI-Fly component. If you have an OSGi 
4.3 compliant framework that supports WeavingHooks you can use the dynamic weaving bundle. </p>
<p>If you have an pre-4.3 OSGi framework or don't want to use bytecode weaving at runtime you 
can use the static weaving approach.</p>
<h2 id="use_with_dynamic_weaving">Use with Dynamic Weaving</h2>
<p>Install and start the <tt>org.apache.aries.spifly.dynamic.bundle</tt> into the system. This bundle 
has a dependency on <tt>org.objectweb.asm</tt> version 3.2 or newer.</p>
<pre>osgi> ss    
Framework is launched.    
id  State       Bundle
0   ACTIVE      org.eclipse.osgi_3.7.0.v20110304
1   ACTIVE      org.objectweb.asm_3.2.0.v200909071300
2   ACTIVE      org.apache.aries.spifly.dynamic.bundle_0.4.0.SNAPSHOT</pre>

<h2 id="use_with_static_weaving">Use with Static Weaving</h2>
<p>For static use, you need to modify the client bundle before installing it into the system. 
The modification changes the byte code around java.util.ServiceLoader.load() calls in the 
bundle and inserts calls to set the correct ThreadContextClassLoader around it.
Provider bundles are still handled dynamically.</p>
<h3 id="to_statically_weave_a_bundle">To statically weave a bundle</h3>
<p>The easiest way to invoke the static weaver is to take the <tt>org.apache.aries.spifly.static.tool</tt>
jar with dependencies. This jar can be created by running <tt>mvn assembly:single</tt> in this maven module.</p>
<p>Then run the static tool on any bundle that needs processing:
<pre>
java -jar org.apache.aries.spifly.static.tool-0.4-with-dependencies.jar mybundle.jar
</pre></p>
<p>This will produce a second bundle with the same name with the _spifly suffix appended, so 
in this case the generated bundle will be called mybundle_spifly.jar.</p>
<p>At runtime, install the <tt>org.apache.aries.spifly.static.bundle</tt> into the system:
<pre>osgi&gt; ss
Framework is launched.
id  State       Bundle
0   ACTIVE      org.eclipse.osgi_3.6.1.R36x_v20100806
1   ACTIVE      org.eclipse.osgi.services_3.2.100.v20100503
2   ACTIVE      org.apache.aries.spifly.static.bundle_0.4.0.SNAPSHOT</pre></p>
<p>Then install and start the statically woven bundle into the system.</p>
<h2 id="examples">Examples</h2>
<p>The <tt>spi-fly-examples</tt> directory contains a number of example bundles that can be 
used for testing or experimenting.</p>
<p>The following modules can be found in this directory:</p>
<ul>
<li><strong>spi-fly-example-spi-bundle</strong> - a bundle providing an SPI interface used by the other example bundles.</li>
<li><strong>spi-fly-example-provider1-jar</strong> - a plain jar file providing an implementation of the SPI (via <tt>META-INF/services</tt>).</li>
<li><strong>spi-fly-example-provider1-bundle</strong> - a bundle that wraps the jar file from the previous bullet and specifies it in its Bundle-ClassPath. This example represents the common case where an existing SPI provider is wrapped as-is in an OSGi bundle.</li>
<li><strong>spi-fly-example-provider2-bundle</strong> - a bundle that directly provides an SPI service (via <tt>META-INF/services</tt>).</li>
<li><strong>spi-fly-example-client1-jar</strong> - a plain jar using java.util.ServiceLoader.load() to obtain and invoke all services provided of a certain SPI.</li>
<li><strong>spi-fly-example-client1-bundle</strong> - a bundle that wraps the jar file from the previous bullet and lists it in its Bundle-ClassPath. This example represents the common case where an existing SPI consumer is wrapped as-is in an OSGi bundle.</li>
<li><strong>spi-fly-example-client2-bundle</strong> - a bundle that has code that invokes <tt>java.util.ServiceLoader.load()</tt> directly.</li>
</ul></div>
            <!-- Content -->
          </td>
        </tr>
      </table>
   </td>
   <td id="cell-2-2" colspan="2">&nbsp;</td>
  </tr>
  <tr width="100%">
   <td id="cell-3-0">&nbsp;</td>
   <td id="cell-3-1">&nbsp;</td>
   <td id="cell-3-2">
     <div id="footer">
       <!-- Footer -->
       <div id="site-footer">
         <a href="http://aries.apache.org/privacy-policy.html";>Privacy
Policy</a> 
       </div>
       <!-- Footer -->
     </div>
   </td>
   <td id="cell-3-3">&nbsp;</td>
   <td id="cell-3-4">&nbsp;</td>
  </tr>
  <tr width="100%">
    <td id="cell-4-0" colspan="2">&nbsp;</td>
    <td id="cell-4-1">&nbsp;</td>
    <td id="cell-4-2" colspan="2">&nbsp;</td>
  </tr>
</table>
</body>
</html> 
