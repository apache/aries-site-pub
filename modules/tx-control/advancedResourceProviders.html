<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd";>
<!--
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements. See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License. You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<html>
  <head>
    <link rel="shortcut icon" href="http://aries.apache.org/images/favicon.ico"></link>
    <link type="text/css" rel="stylesheet" href="http://aries.apache.org/resources/site.css"></link>
    </script><script src="http://aries.apache.org/resources/menus.js" language="javascript" type="text/javascript"></script>
  <meta name="keywords" content="..."/>
  <meta name="description" content="..." />
    <title>
    Apache Aries - 
    </title>
  </head>
<body onload="SetMenu()">

<table width="100%" cellpadding="0" cellspacing="0">
  <tr width="100%">
    <td id="cell-0-0" colspan="2">&nbsp;</td>
    <td id="cell-0-1">&nbsp;</td>
    <td id="cell-0-2" colspan="2">&nbsp;</td>
  </tr>
  <tr width="100%">
    <td id="cell-1-0">&nbsp;</td>
    <td id="cell-1-1">&nbsp;</td>
    <td id="cell-1-2">
      <div style="padding: 5px;">
        <div id="banner">
          <!-- Banner -->
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
        <tr>
          <td align="left" class="topbardiv" nowrap="">
            <a href="http://aries.apache.org/" title="Apache Aries"> <img border="0" src="http://aries.apache.org/images/Arieslogo_Horizontal.gif"> </a>
          </td>
          <td align="right" nowrap="">
            <a href="http://www.apache.org/" title="The Apache Software Foundation"> <img border="0" src="http://aries.apache.org/images/apache_feather.png"> </a>
              </td>
        </tr>
      </table>
          <!-- Banner -->
        </div>
      </div>
      <div id="top-menu">
        <table border="0" cellpadding="1" cellspacing="0" width="100%">
          <tr>
            <td>
              <div align="left">
                <!-- Breadcrumbs -->
                <!-- Breadcrumbs -->
              </div>
            </td>
            <td>
              <div align="right">
                <!-- Quicklinks -->
          <DIV style="padding: 5px 5px 0px 25px;">
            <FORM action="http://www.google.com/search" method="get" style="font-size: 10px;">
            <A href="http://www.apache.org/licenses/LICENSE-2.0.html" class="external-link" rel="nofollow">License</A> 
            <INPUT name="ie" type="hidden" value="UTF-8"></INPUT>
            <INPUT name="oe" type="hidden" value="UTF-8"></INPUT>
            <INPUT maxlength="255" name="q" size="15" type="text" value></INPUT>
            <INPUT name="btnG" type="submit" value="Search"></INPUT>
            <INPUT name="domains" type="hidden" value="aries.apache.org"></INPUT>
            <INPUT name="sitesearch" type="hidden" value="aries.apache.org"></INPUT>
            </FORM>
          </DIV>
                <!-- Quicklinks -->
              </div>
            </td>
          </tr>
        </table>
      </div>
    </td>
    <td id="cell-1-3">&nbsp;</td>
    <td id="cell-1-4">&nbsp;</td>
  </tr>
  <tr width="100%">
    <td id="cell-2-0" colspan="2">&nbsp;</td>
    <td id="cell-2-1">
      <table>
        <tr height="100%" valign="top">
          <td height="100%">
            <div id="wrapper-menu-page-right">
              <div id="wrapper-menu-page-top">
                <div id="wrapper-menu-page-bottom">
                  <div id="menu-page">
                    <!-- NavigationBar -->
          <style type="text/css">
/* The following code is added by mdx_elementid.py
   It was originally lifted from http://subversion.apache.org/style/site.css */
/*
 * Hide class="elementid-permalink", except when an enclosing heading
 * has the :hover property.
 */
.headerlink, .elementid-permalink {
  visibility: hidden;
}
h2:hover > .headerlink, h3:hover > .headerlink, h1:hover > .headerlink, h6:hover > .headerlink, h4:hover > .headerlink, h5:hover > .headerlink, dt:hover > .elementid-permalink { visibility: visible }</style>
<div onclick="SwitchMenu('documentation')" id="documentationTitle" class="menutitle">Documentation</div>

<div id="documentation" class="menuitemgroup">
    <div class="menuitem">
        <a href="/documentation/integrators-guide.html">Integrators Guide</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/articles.html">Articles</a> 
    </div>
    <div class="menuitem">
        <a href="https://svn.apache.org/repos/asf/aries/slides/">Slides</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/tutorials.html">Tutorials</a> 
    </div>
    <div class="menuitem">
        <a href="/documentation/tools.html">Tools</a> 
    </div>
</div>

<div onclick="SwitchMenu('modules')" id="modulesTitle" class="menutitle">Modules</div>

<div id="modules" class="menuitemgroup">
    <div class="menuitem">
        <a href="/modules/samples.html">Samples</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/async-svcs.html">Asynchronous Services</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/blueprint.html">Blueprint</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/blueprint-maven-plugin.html">Blueprint-maven-plugin</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/blueprintannotation.html">Blueprint Annotations</a>
    </div>
    <div class="menuitem">
        <a href="/modules/blueprintnoosgi.html">Blueprint No-OSGi</a>
    </div>
    <div class="menuitem">
        <a href="/modules/blueprintweb.html">Blueprint Web</a>
    </div>
        <div class="menuitem">
                <a href="/modules/containers.html">Containers</a>
        </div>
    <div class="menuitem">
        <a href="/modules/esaanttask.html">ESA Ant Task </a> 
    </div>
    <div class="menuitem">
        <a href="/modules/ebamavenpluginproject.html">EBA Maven Plugin </a> 
    </div>
    <div class="menuitem">
        <a href="/modules/esamavenpluginproject.html">ESA Maven Plugin </a> 
    </div>
    <div class="menuitem">
        <a href="/modules/jmx.html">JMX</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/jndiproject.html">JNDI</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/jpaproject.html">JPA</a> 
    </div>
        <div class="menuitem">
        <a href="/modules/transactioncontrol.html">Transaction Control Service</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/transactionsproject.html">Transactions</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/rsa.html">Remote Service Admin (RSA)</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/spi-fly.html">SPI Fly</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/subsystems.html">Subsystems</a> 
    </div>
    <div class="menuitem">
        <a href="/modules/applications.html">Applications (obsolete)</a> 
    </div>
</div>

<div onclick="SwitchMenu('downloads')" id="downloadsTitle" class="menutitle">Downloads</div>

<div id="downloads" class="menuitemgroup">
    <div class="menuitem">
        <a href="/downloads/currentreleases.html">Current Releases</a> 
    </div>
    <div class="menuitem">
        <a href="/downloads/testresults.html">Compliance Tests</a> 
    </div>
    <div class="menuitem">
        <a href="/downloads/archived-releases.html">Archived Releases</a> 
    </div>
</div>

<div onclick="SwitchMenu('community')" id="communityTitle" class="menutitle">Community</div>

<div id="community" class="menuitemgroup">
    <div class="menuitem">
        <a href="/community/resources.html">Community Resources</a> 
    </div>
    <div class="menuitem">
        <a href="/community/gettinginvolved.html">Getting Involved</a> 
    </div>
    <div class="menuitem">
        <a href="/community/people.html">Who we are</a> 
    </div>
    <div class="menuitem">
        <a href="/community/boardreports.html">Board Reports</a> 
    </div>
        <div class="menuitem">
                <a href="/community/logos.html">Logos for Users</a>
        </div>
</div>

<div onclick="SwitchMenu('development')" id="developmentTitle" class="menutitle">Development</div>

<div id="development" class="menuitemgroup">
    <div class="menuitem">
        <a href="/development/buildingaries.html">Building Aries </a> 
    </div>
    <div class="menuitem">
        <a href="/development/guidelines.html">Cording Guidelines</a> 
    </div>
    <div class="menuitem">
        <a href="/development/architecture.html">Architecture</a> 
    </div>
    <div class="menuitem">
        <a href="/development/releasingaries.html">Releasing Aries </a> 
    </div>
    <div class="menuitem">
        <a href="/development/compliancetesting.html">OSGi Compliance Tests </a> 
    </div>
    <div class="menuitem">
        <a href="/development/maintainingthewebpages.html">Web Site Maintenance </a> 
    </div>
</div>

<div onclick="SwitchMenu('sponsorship')" id="sponsorshipTitle" class="menutitle">Sponsorship</div>

<div id="sponsorship" class="menuitemgroup">
    <div class="menuitem">
        <a href="http://www.apache.org/foundation/thanks.html">Thanks</a> 
    </div>
    <div class="menuitem">
        <a href="http://www.apache.org/foundation/sponsorship.html">Sponsoring Apache</a> 
    </div>
</div>

<div class="promotion">
    <a href="http://www.apache.org/events/current-event.html">
    <img src="http://www.apache.org/events/current-event-125x125.png" width="125" height="125"/>
    </a>
</div>
                    <!-- NavigationBar -->
                  </div>
                </div>
              </div>
            </div>
          </td>
          <td height="100%" width="100%">
            <!-- Content -->
            <div class="wiki-content"><style type="text/css">
/* The following code is added by mdx_elementid.py
   It was originally lifted from http://subversion.apache.org/style/site.css */
/*
 * Hide class="elementid-permalink", except when an enclosing heading
 * has the :hover property.
 */
.headerlink, .elementid-permalink {
  visibility: hidden;
}
h2:hover > .headerlink, h3:hover > .headerlink, h1:hover > .headerlink, h6:hover > .headerlink, h4:hover > .headerlink, h5:hover > .headerlink, dt:hover > .elementid-permalink { visibility: visible }</style>
<h1 id="making-your-own-resource-provider">Making your own Resource Provider<a class="headerlink" href="#making-your-own-resource-provider" title="Permanent link">&para;</a></h1>
<p>The <code>TransactionControl</code> service is based around the use of <code>ResourceProvider</code>
instances. When combined the client receives a thread-safe resource instance that they can use.</p>
<p>Resource Provider implementations already exist for <a href="localJDBC.html">JDBC</a>, <a href="xaJDBC.html">XA JDBC</a>, <a href="localJPA.html">JPA</a> and <a href="xaJPA.html">XA JPA</a></p>
<h2 id="create-an-interface">Create an interface<a class="headerlink" href="#create-an-interface" title="Permanent link">&para;</a></h2>
<p>If you need to create your own Resource Provider then you should define a sub-interface which declares the
type of the resource. This allows clients type-safe access to the resources, and makes it easier to identify
the right Resource Provider at runtime.</p>
<div class="codehilite"><pre><span class="n">public</span> <span class="n">interface</span> <span class="n">MyCustomResourceProvider</span> <span class="n">extends</span> 
                    <span class="n">ResourceProvider</span><span class="o">&lt;</span><span class="n">MyCustomResource</span><span class="o">&gt;</span> <span class="p">{}</span>
</pre></div>


<h2 id="create-an-implementation">Create an implementation<a class="headerlink" href="#create-an-implementation" title="Permanent link">&para;</a></h2>
<p>The implementation of a ResourceProvider should return a thread-safe delegating proxy. This may be a
dynamic proxy or a static one. The proxy delegates to the real resource, and is responsible for ensuring
that the thread consistently accesses the same physical resource throughout the scope. Note that even 
when multiple proxies are created they should share the same physical resource throughout the life of the
context.</p>
<h3 id="lifecycle-first-access">Lifecycle - first access<a class="headerlink" href="#lifecycle-first-access" title="Permanent link">&para;</a></h3>
<p>Whenever the resource is accessed then it must check to see whether it has already been accessed 
within the current scope. If not then a resource should be selected and associated with the scope. This
physical resource must then be used for the rest of the scope.</p>
<p>Note that if there is no active scope when the resource is accessed then the resource access should 
fail with a TransactionException.</p>
<div class="codehilite"><pre><span class="cm">/**</span>
<span class="cm"> *  A resource method</span>
<span class="cm"> */</span>
<span class="p">@</span><span class="n">Override</span>
<span class="n">public</span> <span class="n">boolean</span> <span class="n">doSomething</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">txControl</span><span class="p">.</span><span class="n">activeScope</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">throw</span> <span class="k">new</span> <span class="n">TransactionException</span><span class="p">(</span><span class="s">&quot;There is no scope currently active&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Locate, or create and associate</span>
    <span class="n">MyCustomResource</span> <span class="n">delegate</span> <span class="o">=</span> <span class="n">locateDelegate</span><span class="p">(</span><span class="n">txControl</span><span class="p">.</span><span class="n">getCurrentContext</span><span class="p">());</span>

    <span class="k">return</span> <span class="n">delegate</span><span class="p">.</span><span class="n">doSomething</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<h3 id="lifecycle-enlisting">Lifecycle - enlisting<a class="headerlink" href="#lifecycle-enlisting" title="Permanent link">&para;</a></h3>
<p>If a transaction is active then the resource should enlist with it when it is first used. If the resource is
usable with XA transactions then it should register an XAResource.</p>
<div class="codehilite"><pre><span class="n">private</span> <span class="n">MyCustomResource</span> <span class="n">locateDelegate</span><span class="p">(</span><span class="n">TransactionContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">MyCustomResource</span> <span class="n">resource</span> <span class="p">=</span> <span class="n">findExisting</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">resource</span> !<span class="p">=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">resource</span> <span class="p">=</span> <span class="n">getNewDelegate</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">activeTransaction</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">supportsXA</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">registerXAResource</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">getXAResource</span><span class="p">());</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">throw</span> <span class="n">new</span> <span class="n">TransactionException</span><span class="p">(</span>&quot;<span class="n">The</span> <span class="n">transaction</span> <span class="n">does</span> <span class="n">not</span> <span class="n">support</span> <span class="n">XA</span> <span class="n">resources</span>&quot;<span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="o">//</span> <span class="n">Other</span> <span class="n">resource</span> <span class="n">preparation</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">resource</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Local resources are similar, but they register a LocalResource, not an XAResource.</p>
<div class="codehilite"><pre><span class="n">private</span> <span class="n">MyCustomResource</span> <span class="n">locateDelegate</span><span class="p">(</span><span class="n">TransactionContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">MyCustomResource</span> <span class="n">resource</span> <span class="p">=</span> <span class="n">findExisting</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">resource</span> !<span class="p">=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">resource</span> <span class="p">=</span> <span class="n">getNewDelegate</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">activeTransaction</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">supportsLocal</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">registerLocalResource</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">getLocalesource</span><span class="p">());</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">throw</span> <span class="n">new</span> <span class="n">TransactionException</span><span class="p">(</span>&quot;<span class="n">The</span> <span class="n">transaction</span> <span class="n">does</span> <span class="n">not</span> <span class="n">support</span> <span class="n">Local</span> <span class="n">resources</span>&quot;<span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="o">//</span> <span class="n">Other</span> <span class="n">resource</span> <span class="n">preparation</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">resource</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h3 id="lifecycle-tidying-up">Lifecycle - Tidying up<a class="headerlink" href="#lifecycle-tidying-up" title="Permanent link">&para;</a></h3>
<p>In addition to registering with an active transaction the resource should also register for cleanup at the end
of the scope. This may involve closing the physical resource, or returning it to a pool.</p>
<div class="codehilite"><pre><span class="c1">// Other resource preparation</span>

<span class="k">context</span><span class="p">.</span><span class="n">postCompletion</span><span class="p">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">resource</span><span class="p">.</span><span class="k">release</span><span class="p">());</span>
</pre></div>


<h2 id="other-things-to-look-out-for">Other things to look out for...<a class="headerlink" href="#other-things-to-look-out-for" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>A client must have a friendly way to access the ResourceProvider. This may be directly via the OSGi Service 
Registry or via a factory service of some kind.</p>
</li>
<li>
<p>A resource must remain valid throughout a scope, therefore clients should not be able to close or return the
resource by making calls on the thread-safe proxy. Typically calls to close should be a silent no-op (the
actual close will occur when the scope ends).</p>
</li>
<li>
<p>When a transaction is active clients must not be able to manually commit or rollback the resource.
Methods like <code>commit</code>, <code>rollback</code> and <code>setRollbackOnly</code> must
fail with a TransactionException indicating the incorrect usage. This is different from <code>close</code>
behaviour because unlike deferring a <code>close</code> ignoring a <code>rollback</code> results in a 
different overall result from the client's perspective.</p>
</li>
<li>
<p>Resources must not rely on the Transaction Control service recognising duplicate enlistments. A resource
should be enlisted at most once.</p>
</li>
</ol></div>
            <!-- Content -->
          </td>
        </tr>
      </table>
   </td>
   <td id="cell-2-2" colspan="2">&nbsp;</td>
  </tr>
  <tr width="100%">
   <td id="cell-3-0">&nbsp;</td>
   <td id="cell-3-1">&nbsp;</td>
   <td id="cell-3-2">
     <div id="footer">
       <!-- Footer -->
       <div id="site-footer">
         <a href="http://aries.apache.org/privacy-policy.html";>Privacy
Policy</a> 
       </div>
       <!-- Footer -->
     </div>
   </td>
   <td id="cell-3-3">&nbsp;</td>
   <td id="cell-3-4">&nbsp;</td>
  </tr>
  <tr width="100%">
    <td id="cell-4-0" colspan="2">&nbsp;</td>
    <td id="cell-4-1">&nbsp;</td>
    <td id="cell-4-2" colspan="2">&nbsp;</td>
  </tr>
</table>
</body>
</html> 
